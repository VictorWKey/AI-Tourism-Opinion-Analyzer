"""
Utilidades para An√°lisis de Subjetividad
=======================================

Este m√≥dulo contiene funciones auxiliares y utilidades para el an√°lisis
de subjetividad de opiniones tur√≠sticas.

Autor: Sistema de An√°lisis de Opiniones Tur√≠sticas
Fecha: 2025
"""

import pandas as pd
import warnings
warnings.filterwarnings('ignore')



def limpiar_texto_opiniones(df: pd.DataFrame, columna_texto: str = 'TituloReview') -> pd.DataFrame:
    """
    Limpia y preprocesa el texto de las opiniones.
    
    Args:
        df (pd.DataFrame): Dataset con columna de texto
        columna_texto (str): Nombre de la columna con el texto
        
    Returns:
        pd.DataFrame: Dataset con texto limpio
    """
    df_limpio = df.copy()
    
    # Eliminar valores nulos y convertir a string
    df_limpio[columna_texto] = df_limpio[columna_texto].fillna("").astype(str)
    
    # Eliminar espacios extra
    df_limpio[columna_texto] = df_limpio[columna_texto].str.strip()
    
    # Filtrar opiniones muy cortas (menos de 10 caracteres)
    longitud_inicial = len(df_limpio)
    df_limpio = df_limpio[df_limpio[columna_texto].str.len() >= 10]
    longitud_final = len(df_limpio)
    
    if longitud_inicial != longitud_final:
        print(f"üßπ Texto limpiado: eliminadas {longitud_inicial - longitud_final} opiniones muy cortas")
    
    return df_limpio


def exportar_resultados_csv(df: pd.DataFrame, ruta_salida: str, incluir_index: bool = False) -> bool:
    """
    Exporta los resultados del an√°lisis a un archivo CSV.
    
    Args:
        df (pd.DataFrame): Dataset con resultados
        ruta_salida (str): Ruta donde guardar el archivo
        incluir_index (bool): Si incluir el √≠ndice en el archivo
        
    Returns:
        bool: True si se export√≥ exitosamente, False en caso contrario
    """
    try:
        df.to_csv(ruta_salida, index=incluir_index, encoding='utf-8')
        print(f"‚úÖ Resultados exportados exitosamente a: {ruta_salida}")
        print(f"üìä Total de registros exportados: {len(df)}")
        return True
    except Exception as e:
        print(f"‚ùå Error al exportar resultados: {e}")
        return False


def obtener_estadisticas_texto(df: pd.DataFrame, columna_texto: str = 'TituloReview') -> dict:
    """
    Obtiene estad√≠sticas b√°sicas del texto en el dataset.
    
    Args:
        df (pd.DataFrame): Dataset a analizar
        columna_texto (str): Nombre de la columna con el texto
        
    Returns:
        dict: Estad√≠sticas del texto
    """
    if columna_texto not in df.columns:
        print(f"‚ùå Error: No se encontr√≥ la columna '{columna_texto}'")
        return {}
    
    textos = df[columna_texto].astype(str)
    longitudes = textos.str.len()
    
    estadisticas = {
        'total_textos': len(textos),
        'textos_vacios': (textos == '').sum(),
        'longitud_promedio': longitudes.mean(),
        'longitud_mediana': longitudes.median(),
        'longitud_min': longitudes.min(),
        'longitud_max': longitudes.max(),
        'longitud_std': longitudes.std()
    }
    
    return estadisticas


def mostrar_estadisticas_texto(df: pd.DataFrame, columna_texto: str = 'TituloReview') -> None:
    """
    Muestra las estad√≠sticas de texto en consola.
    
    Args:
        df (pd.DataFrame): Dataset a analizar
        columna_texto (str): Nombre de la columna con el texto
    """
    estadisticas = obtener_estadisticas_texto(df, columna_texto)
    
    if not estadisticas:
        return
    
    print("üìù ESTAD√çSTICAS DE TEXTO")
    print("=" * 40)
    print(f"Total de textos: {estadisticas['total_textos']}")
    print(f"Textos vac√≠os: {estadisticas['textos_vacios']}")
    print(f"Longitud promedio: {estadisticas['longitud_promedio']:.1f} caracteres")
    print(f"Longitud mediana: {estadisticas['longitud_mediana']:.1f} caracteres")
    print(f"Longitud m√≠nima: {estadisticas['longitud_min']} caracteres")
    print(f"Longitud m√°xima: {estadisticas['longitud_max']} caracteres")
    print(f"Desviaci√≥n est√°ndar: {estadisticas['longitud_std']:.1f} caracteres")
